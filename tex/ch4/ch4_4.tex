\section{Určení magnetické anizotropie}
\label{chap:urceni-magneticke-anizotropie}

Určení magnetické anizotropie z měřených dat je do jisté míry oddělené od určení síly MO jevů.
Předpokládáme, že $\phih$-závislost měřeného rozdílového napětí $\Udif$ je pouze skrze $\phim(\phih)$ udávajícího směr saturované in-plane magnetizace $\vec{M}$.
Znamená to, že ve vzorku je jediná MO aktivní vrstva, případně ve všech vrstvách je $\phim(\phih)$ totožné.
Zároveň je také nutné odstranit všechny příspěvky do signálu, které nepochází přímo od vzorku (např. MO jevy v okénkách kryostatu, či pohyb čehokoliv v experimentálním uspořádání vlivem změny směru magnetického pole).
Tento požadavek je naprosto zásadní.

Dále předpokládáme, že signál je dobře popsaný konečným počtem členů mocninného rozvoje v $\vec{M}$.
V této práci se omezujeme na kvadratické členy (po odstranění lineárních jevů způsobem popsaném v předešlém oddílu -- viz vztah \eqref{eqn:PMLD-matice}), které mají vzhledem k magnetické saturaci tvar
\begin{equation}
\label{eqn:anizotropie-fit}
    \Udif(\phih) = b_0 + b_\textrm{c} \cos2\phim(\phih) + b_\textrm{s} \sin2\phim(\phih) \,.
\end{equation}
Omezení na kvadratické členy však není nezbytné.
Pokud z předpokládané symetrie problému vycházejí i jiné členy (např. pro [111] normálově orientované kubické vzorky členy harmonické v $3\phim$, $6\phim$), není problém je do \eqref{eqn:anizotropie-fit} zahrnout.
Stejně tak není nutné provádět symetrizaci v $\vHext$ pro odstranění lineárních jevů, a místo toho zahrnout členy harmonické v $1\phim$.
Níže popsaná metoda teoreticky (ověřeno na simulacích bez šumu) funguje s libovolným počtem členů, který nepřesáhne určitou mez, za kterou je fit degenerovaný.
Jediný problém, který s sebou přidávání parametrů přináší, je zřejmé zvyšování jejich počtu.
V této práci se však dále věnujeme pouze kvadratickým členům s rozvojem \eqref{eqn:anizotropie-fit}.

Pokud naměříme $\Udif$ pro sadu $\phih$, a signál je skutečně dán vzorcem \eqref{eqn:anizotropie-fit}, je možné z něj extrahovat závislost $\phim(\phih)$.
Nejprve uvedeme pár poznámek o degeneraci.
Pokud změříme $n$ různých (s lineárně nezávislými koeficienty $b$) závislostí $\Udif(\phim)$ (například pro různé polarizace $\beta$) pro $m$ hodnot $\phih$, pak je naším cílem zjistit celkem $m+3n$ parametrů -- $m$ hodnot $\phim(\phih)$ a $3\times n$ parametrů \eqref{eqn:anizotropie-fit} -- z $n\times m$ změřených bodů.
Pro $n=1$ je vždy parametrů více než dat, pro $n\geq 2$ je situace v pořádku (typicky $m>\,$počet členů v rozvoji).
Rozdíl mezi $n=1,\,2$ lze intuitivně pochopit na jiné formálně ekvivalentní úloze.
Po vykreslení bodů $(\Udif^{(1)}(\phih), \Udif^{(2)}(\phih)$ do roviny\footnote{Pokud měříme jen $\Udif^{(1)}$, pak pokládáme $\Udif^{(2)}=0$} leží podle \eqref{eqn:anizotropie-fit} body na nějaké elipse.
V této analogii je naším úkolem elipsu identifikovat, a zároveň pro každý bod určit, v které části elipsy leží (což odpovídá $\phim(\phih)$).
Pro obyčejnou elipsu to je jednoznačné, pokud však $n=1$, nebo jsou trojice parametrů $b$ pro obě měření lineárně závislé, je elipsa redukovaná na přímku.
U té řešení jednoznačné není -- délka úsečky může být libovolná delší než nejvzdálenější naměřené body.
To s sebou nese i nejednoznačnost v $\phim(\phih)$.

Problém trpí ještě jedním typem nezávažné degenerace -- celkové pootočení $\phim$ oproti $\phih$.
Pokud bychom měli dva průběhy magnetizace, které se liší pouze celkovým pootočením, tj. $\phim^2(\phih)=\phim^1 + \textrm{konst.}$,
pak je možné vhodnou lineární transformací (``pootočením'') parametrů $b_1$, $b_2$ dosáhnout toho, aby model \eqref{eqn:anizotropie-fit} dával totožné hodnoty.
To znamená, že fitem naměřených dat nelze rozlišit mezi $\phim^1$ a $\phim^2$ -- je možné pouze určit třídu ekvivalence průběhů $\phim(\phih)$, jejíž prvky se navzájem liší aditivní konstantou (celkovým pootočením).
Naštestí nám však v tuto chvíli spěchá na pomoc termodynamika s podmínkou integrability \eqref{eqn:podminka-integrability}, která z každé takové třídy vybírá právě jedno $\phim(\phih)$, pro které existuje volná energie.

Výhoda odděleného zpracování magnetické anizotropie a určení anizotropie MO koeficientů je taková, že je možné ho provést i v případě, kdy nejsou splněny požadavky pro určení síly MO jevů.
Konkrétně např. není nutné kompenzovat zrcadla ani nepřesnosti vlnových destiček, tj. můžeme měřit libovolný mix stočení a elipticity.
Také je možné měřit v situacích, kdy měřený signál nemá správnou $\beta$-závislost \eqref{eqn:PMLD-matice}, tj. nekolmý dopad či vzorek s nezanedbatelnou strukturální anizotropií (tj. když konstantní člen transmisní/reflexní matice se výrazně liší od jednotkové matice).
Není ani nutné mít při vstupu do vzorku lineárně polarizované světlo -- dokonce není ani nutné polarizační stav znát.
Jediným předpokladem je, že reflexní matice vzorku je dobře popsaná mocninným rozvojem v $\vec{M}$.

Nyní již přistoupíme k samotnému procesu extrakce $\phim(\phih)$.
Základem je opět aplikace metody nejmenších čtverců -- hledání parametrů, které minimalizují cílovou funkci $\mathcal{L}$ tvaru \eqref{eqn:L} s modelem \eqref{eqn:anizotropie-fit}.
Narozdíl od všech předchozích popsaných aplikací však tentokrát fit nelze zcela linearizovat, proto používáme některou z dostupných vícedimenzionálních minimalizačních metod, např. \emph{gradientní sestup}.
Část fitu odpovídající parametrům $b$ linearizovat lze.
Postupujeme tedy tak, že cílovou funkci $\mathcal{L}$ považujeme pouze za funkci $\phim(\phih)$, s předpokladem, že jsou dosazeny optimální parametry $b$ pro dané $\phim(\phih)$, určené lineární regresí\footnote{Do \eqref{eqn:anizotropie-fit} je dosazeno konkrétní $\phim$ a jsou fitovány parametry $b$.}.
Gradientní sestup je pak aplikován pouze na parametry $\phim(\phih)$.
Jako startovní bod iterací zpravidla volíme nulovou magnetickou anizotropii $\phim(\phih)=\phih$.

V této podobě není výhodné aplikovat podmínky integrability již během fitu, protože gradient cílové funkce je kolmý na směr, který způsobuje celkové pootočení magnetizace -- gradientní sestup ji přirozeně dodržuje.
Přesto je však jistější jí po provedení fitu aplikovat a vybrat tu správnou aditivní konstantu.

V praxi je měřeno mnoho hodnot $\phih$, a přestože je uvedená metoda zcela spolehlivá v simulacích, v přítomnosti šumu zpravidla nelze spoléhat na výsledky fitů s více než 20 parametry.
Proto závislost $\phim(\phih)$ parametrizujeme menším počtem parametrů než $\phim$ pro každé měřené $\phih$.
V případě námi měřených vzorků používáme parametrizaci Stonerova-Wohlfarthova modelu \eqref{eqn:SW-funkcional} s kubickou $k_4$ a uniaxiální $k_u$ anizotropní konstantou, jimi svíraným úhlem $\phiu$ a in-plane rotací vzorku $\gamma$.
Pro potřeby fitu je výrazně výhodnější místo nich používat ekvivalentní parametrizaci pomocí $\tilde{k}_4$ a $\tilde{k}_u$\footnote{Jejich reálné a imaginární části.} (viz \eqref{eqn:funkcional-otoceny}), která ale navíc zachovává přirozenou topologii parametrického prostoru\footnote{V tomto vyjádření např. splývají $\phiu$ a $\phiu+\SI{180}{\degree}$, nebo $k_u=0$ pro všechna $\phiu$} a místo $\phiu$ používá $\gamma+\phiu$, tedy směr uniaxiální anizotropie v experimentální souřadné soustavě.
To umožňuje její směr spolehlivě určit např. v případě, kdy je kubická anizotropie z nějakého důvodu zatížena velkou chybou (např. je mnohem slabší než uniaxiální).

V této podobě výpočet cílové funkce $\mathcal{L}(\Re\tilde{k}_4,\,\Im\tilde{k}_4,\,\Re\tilde{k}_u,\,\Im\tilde{k}_u)$ probíhá ve třech krocích
\begin{enumerate}
    \item Pro pevně danou sadu $\phih$ je minimalizací magnetické entalpie \eqref{eqn:magneticka-entalpie-v-rovine} spočítaná sada $\phim$.
    \item Tato $\phim$ jsou dosazena do \eqref{eqn:anizotropie-fit} a metodou lineární regrese jsou spočítány parametry $b$.
    \item Je spočítaná celková kvadratická odchylka měřených dat od \eqref{eqn:anizotropie-fit} s dosazenými $b$.
\end{enumerate}
Libovolnou metodou je pak numericky nalezeno globální minimum $\mathcal{L}$.

Popsaná optimalizační úloha je poměrně výpočetně náročná, a proto zmíníme pár vypozorovaných rysů, které mohou pomoci s její optimalizací.
Hlavním problémem je zřejmě výpočet $\phim$ s danými anizotropními konstantami.
V ideálním případě je provedena úloha hledání minima či nuly pro každou hodnotu $\phih$.
Pro předběžné hledání minima $\mathcal{L}$ lze ale využít přibližných výpočtů popsaných v dodatku \ref{app:magneticka-anizotropie}.
Numerickému počítání gradientu $\mathcal{L}$ se lze vyhnout pomocí analytických derivací $\phim$ podle anizotropních konstant, taktéž popsaných v dodatku \ref{app:magneticka-anizotropie}.
Dále pro nulovou anizotropii je vždy Hessova matice cílové funkce diagonální\footnote{Derivace regresorů podle anizotropních konstant (sloupce Jacobiho matice) jsou ortogonální.}.
To znamená, že pro slabou anizotropii jsou linearizované parametry ($\Re \tilde{k}_4$, \ldots) bez vzájemných korelací.

Pokud rozvoj signálu v $\vec{M}$ sestává pouze z jediné frekvence $\phim$ (v našem zaměření na kvadratické jevy to je $2\phim$), pak má metoda poměrně přímočarou geometrickou interpretaci, a z dat lze vizuálně přímo odečítat přibližné polohy snadných a těžkých os.
Toto ilustrujeme na sadě dat naměřených se vzorkem CoFe při pokojové teplotě v transmisní geometrii bez zrcadel mezi vzorkem a detekcí.
S daty byla provedena procedura kompenzace nedokonalostí destiček (viz oddíl \ref{chap:kompenzace}) a symetrizace v $\vHext$ pro odstranění lineárních jevů (viz vztah \eqref{eqn:symetrizace-H}).

Měřený signál je harmonickou funkcí v $2\phim$, viz obr. \ref{fig:anizotropie-vizualni} (b)\footnote{Tento obrázek je však až výsledkem analýzy. $\phim$ apriori neznáme.}.
Experimentální data přirozeně vykreslujeme v závislosti na $\phih$, jakékoliv odchylky tvaru od harmonické funkce jsou způsobeny magnetickou anizotropií $\phim\neq\phih$, viz obr. \ref{fig:anizotropie-vizualni} (a) a (c).
Provedená transformace mezi oběma grafy ($\phih \mapsto \phim$) má význam lokálního škálování vodorovné osy, na obrázcích znázorněno svislými čarami s konstantními rozestupy ve $\phim$.
Míra škálování je přibližně dána (viz dodatek \ref{app:magneticka-anizotropie})
\begin{equation}
    \frac{\textrm{d}\phim}{\textrm{d}\phih} = \frac{1}{1+\frac{\textrm{d}^2 F}{\textrm{d}\phim^2}\frac{1}{\mu_0 \Hext M_S \cos(\phim-\phih)}} \,.
\end{equation}

Snadná osa se vždy nachází v regionu $\textrm{d}^2F/\textrm{d}\phim^2 > 0$ a dochází k natahování ($\textrm{d}\phim/\textrm{d}\phih < 1$, na obrázku v oblasti $\phih\approx\SI{45}{\degree}$), těžká osa v regionu s opačnou nerovnicí a dochází ke smršťování ($\phih\approx\SI{90}{\degree}$).

\begin{figure}[htbp]
    \centering
    \includegraphics{./data/out/anizotropie-ukazka.pdf}
    \caption{Ilustrace určení magnetické anizotropie. Měřená data s CoFe v závislost na (a) přikládaném poli, (b) průběhu magnetizace získaném z analýzy.
    Zvýrazněné čáry jsou ekvidistantní ve $\phim$. Jejich snížená hustota značí snadnou osu, zvýšená těžkou osu magnetizace. (c) Závislost $\phim(\phih)$ (vykreslen rozdíl).}
    \label{fig:anizotropie-vizualni}
\end{figure}


